<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ å»å¤§é“çš„ç¬¬Nä½ä¹˜å®¢ | Karak Highway</title>
    <meta name="description" content="å—æ´‹é¢¨æ ¼é©šæ‚šäº’å‹•éŠæˆ² - é¦¬ä¾†è¥¿äºåŠ å»å¤§é“çš„éƒ½å¸‚å‚³èªª">
    <meta name="theme-color" content="#0a0a0a">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ============================================
           CSS Variables & Reset
           ============================================ */
        :root {
            --color-bg: #0a0a0a;
            --color-bg-secondary: #1a0a0a;
            --color-text: #e0e0e0;
            --color-text-dim: #888;
            --color-blood: #8b0000;
            --color-blood-glow: rgba(139, 0, 0, 0.5);
            --color-gold: #d4af37;
            --color-danger: #ff4444;
            --color-success: #44ff44;
            --color-accent: #ff6b6b;
            --font-serif: 'Noto Serif TC', serif;
            --font-sans: 'Noto Sans TC', sans-serif;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-sans);
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.8;
            -webkit-font-smoothing: antialiased;
        }

        /* ============================================
           Game Container & Layout
           ============================================ */
        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a0505 50%, #0a0a0a 100%);
        }

        /* Fear Effects - Red Breathing Border */
        .fear-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .fear-overlay.active {
            opacity: 1;
        }

        .fear-border-top,
        .fear-border-bottom,
        .fear-border-left,
        .fear-border-right {
            position: absolute;
            background: linear-gradient(to bottom, var(--color-blood-glow), transparent);
            animation: breathe 2s ease-in-out infinite;
        }

        .fear-border-top {
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(to bottom, var(--color-blood-glow), transparent);
        }

        .fear-border-bottom {
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(to top, var(--color-blood-glow), transparent);
            animation-delay: 1s;
        }

        .fear-border-left {
            top: 0;
            left: 0;
            bottom: 0;
            width: 100px;
            background: linear-gradient(to right, var(--color-blood-glow), transparent);
            animation-delay: 0.5s;
        }

        .fear-border-right {
            top: 0;
            right: 0;
            bottom: 0;
            width: 100px;
            background: linear-gradient(to left, var(--color-blood-glow), transparent);
            animation-delay: 1.5s;
        }

        @keyframes breathe {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        /* Vignette Effect */
        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 50;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.7) 100%);
        }

        /* Screen Shake */
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-5px) rotate(-0.5deg); }
            20% { transform: translateX(5px) rotate(0.5deg); }
            30% { transform: translateX(-5px) rotate(-0.5deg); }
            40% { transform: translateX(5px) rotate(0.5deg); }
            50% { transform: translateX(-3px); }
            60% { transform: translateX(3px); }
            70% { transform: translateX(-2px); }
            80% { transform: translateX(2px); }
            90% { transform: translateX(-1px); }
        }

        /* Flash Effect */
        .flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.1s ease;
        }

        .flash-overlay.active {
            opacity: 0.6;
        }

        /* ============================================
           Title Screen
           ============================================ */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
        }

        .title-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a0505 30%, #0a0a0a 100%);
        }

        .title-screen h1 {
            font-family: var(--font-serif);
            font-size: clamp(2rem, 8vw, 4rem);
            color: #fff;
            text-shadow: 0 0 30px var(--color-blood-glow);
            margin-bottom: 10px;
            animation: titlePulse 3s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { text-shadow: 0 0 30px var(--color-blood-glow); }
            50% { text-shadow: 0 0 50px var(--color-blood), 0 0 80px var(--color-blood-glow); }
        }

        .title-screen .subtitle {
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            color: var(--color-text-dim);
            margin-bottom: 40px;
        }

        .title-screen .warning {
            max-width: 400px;
            padding: 15px 20px;
            border: 1px solid var(--color-blood);
            border-radius: 8px;
            margin-bottom: 40px;
            background: rgba(139, 0, 0, 0.1);
        }

        .title-screen .warning-title {
            color: var(--color-blood);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .title-screen .warning-text {
            font-size: 0.85rem;
            color: var(--color-text-dim);
        }

        .btn {
            padding: 15px 50px;
            font-family: var(--font-sans);
            font-size: 1.1rem;
            font-weight: 500;
            color: #fff;
            background: linear-gradient(135deg, var(--color-blood) 0%, #5a0000 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--color-blood-glow);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .title-screen .credits {
            position: absolute;
            bottom: 20px;
            font-size: 0.75rem;
            color: var(--color-text-dim);
        }

        /* ============================================
           Game Screen
           ============================================ */
        .game-screen {
            flex-direction: column;
            background: var(--color-bg);
        }

        /* Status Bar */
        .status-bar {
            padding: 15px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.7));
            border-bottom: 1px solid #222;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            z-index: 10;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 120px;
        }

        .stat-icon {
            font-size: 1.2rem;
        }

        .stat-bar {
            flex: 1;
            height: 8px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
            min-width: 60px;
        }

        .stat-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .stat-fill.health { background: linear-gradient(90deg, #8b0000, #ff4444); }
        .stat-fill.sanity { background: linear-gradient(90deg, #4a0080, #9944ff); }
        .stat-fill.karma { background: linear-gradient(90deg, #806000, #d4af37); }

        .stat-value {
            font-size: 0.75rem;
            color: var(--color-text-dim);
            min-width: 40px;
            text-align: right;
        }

        /* Narrative Area */
        .narrative-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .narrative-content {
            max-width: 700px;
            width: 100%;
        }

        .scene-title {
            font-size: 0.8rem;
            color: var(--color-text-dim);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .narrative-box {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .narrative-text {
            font-family: var(--font-serif);
            font-size: clamp(1rem, 2.5vw, 1.15rem);
            line-height: 2;
            white-space: pre-wrap;
        }

        .narrative-text .highlight {
            color: var(--color-accent);
            font-weight: 700;
        }

        .narrative-text .blood {
            color: var(--color-blood);
            font-weight: 700;
            text-shadow: 0 0 10px var(--color-blood-glow);
        }

        .narrative-text .ghost {
            color: #aaa;
            font-style: italic;
        }

        .narrative-text .malay {
            color: var(--color-gold);
            font-style: italic;
        }

        /* Inner Monologue */
        .inner-monologue {
            background: rgba(139, 0, 0, 0.1);
            border: 1px solid rgba(139, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 20px;
        }

        .inner-monologue-label {
            font-size: 0.75rem;
            color: var(--color-blood);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .inner-monologue-text {
            font-family: var(--font-serif);
            font-style: italic;
            color: #bbb;
            font-size: clamp(0.95rem, 2.3vw, 1.05rem);
            line-height: 1.9;
        }

        /* Typewriter Cursor */
        .cursor {
            display: inline-block;
            width: 3px;
            height: 1.2em;
            background: var(--color-blood);
            margin-left: 2px;
            animation: blink 0.8s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Choices Area */
        .choices-area {
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.8));
            border-top: 1px solid #222;
        }

        .choices-container {
            max-width: 700px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px 20px;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            color: var(--color-text);
            font-family: var(--font-sans);
            font-size: clamp(0.9rem, 2.2vw, 1rem);
            text-align: left;
            cursor: pointer;
            transition: all var(--transition-normal);
            opacity: 0;
            transform: translateX(-20px);
            animation: slideIn 0.3s ease forwards;
        }

        .choice-btn:nth-child(1) { animation-delay: 0.1s; }
        .choice-btn:nth-child(2) { animation-delay: 0.2s; }
        .choice-btn:nth-child(3) { animation-delay: 0.3s; }
        .choice-btn:nth-child(4) { animation-delay: 0.4s; }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .choice-btn:hover {
            background: rgba(139, 0, 0, 0.2);
            border-color: var(--color-blood);
            transform: translateX(10px);
        }

        .choice-btn:active {
            transform: scale(0.98);
        }

        .choice-number {
            color: var(--color-blood);
            font-weight: 700;
            min-width: 24px;
        }

        .choice-text {
            flex: 1;
        }

        /* Free Input */
        .free-input-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .free-input-hint {
            font-size: 0.85rem;
            color: var(--color-text-dim);
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(139, 0, 0, 0.1);
            border-left: 3px solid var(--color-blood);
            border-radius: 0 8px 8px 0;
        }

        .free-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .free-input {
            flex: 1;
            padding: 15px 20px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #333;
            border-radius: 10px;
            color: var(--color-text);
            font-family: var(--font-sans);
            font-size: 1rem;
            outline: none;
            transition: all var(--transition-normal);
        }

        .free-input:focus {
            border-color: var(--color-blood);
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.2);
        }

        .free-input::placeholder {
            color: #555;
        }

        .submit-btn {
            padding: 15px 25px;
            background: var(--color-blood);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-family: var(--font-sans);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .submit-btn:hover {
            background: #a00;
            transform: scale(1.05);
        }

        /* Skip Hint */
        .skip-hint {
            text-align: center;
            font-size: 0.75rem;
            color: var(--color-text-dim);
            margin-top: 15px;
            opacity: 0.6;
        }

        /* ============================================
           Inventory Panel
           ============================================ */
        .inventory-toggle {
            position: fixed;
            top: 80px;
            right: 15px;
            width: 50px;
            height: 50px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #333;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 80;
            transition: all var(--transition-normal);
        }

        .inventory-toggle:hover {
            border-color: var(--color-blood);
            transform: scale(1.1);
        }

        .inventory-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--color-blood);
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inventory-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            max-width: 90vw;
            height: 100%;
            background: rgba(15, 15, 15, 0.98);
            border-left: 1px solid #333;
            z-index: 90;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .inventory-panel.open {
            right: 0;
        }

        .inventory-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-header h3 {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .inventory-close {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid #333;
            border-radius: 8px;
            color: var(--color-text-dim);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .inventory-close:hover {
            border-color: var(--color-blood);
            color: var(--color-blood);
        }

        .inventory-items {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .inventory-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: rgba(30, 30, 30, 0.5);
            border: 1px solid #333;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all var(--transition-fast);
        }

        .inventory-item:hover {
            border-color: #555;
            background: rgba(40, 40, 40, 0.5);
        }

        .inventory-item.special {
            border-color: var(--color-gold);
            background: rgba(212, 175, 55, 0.05);
        }

        .item-icon {
            font-size: 1.8rem;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .item-desc {
            font-size: 0.8rem;
            color: var(--color-text-dim);
            line-height: 1.5;
        }

        .item-charges {
            font-size: 0.75rem;
            color: var(--color-gold);
            margin-top: 5px;
        }

        /* Inventory Overlay */
        .inventory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 85;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .inventory-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* ============================================
           Status Display (Bottom)
           ============================================ */
        .game-status {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.95);
            border-top: 1px solid #222;
        }

        .flags-display {
            max-width: 700px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .flag-item {
            padding: 5px 12px;
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid #333;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--color-text-dim);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .flag-item.active {
            border-color: var(--color-gold);
            color: var(--color-gold);
        }

        .flag-item .flag-icon {
            font-size: 0.8rem;
        }

        /* ============================================
           Ending Screen
           ============================================ */
        .ending-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 30px;
            background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%);
        }

        .ending-type {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 20px;
            animation: fadeInUp 0.5s ease forwards;
        }

        .ending-type.good { color: #44ff44; }
        .ending-type.bad { color: #ff4444; }
        .ending-type.neutral { color: #888; }

        .ending-title {
            font-family: var(--font-serif);
            font-size: clamp(2rem, 7vw, 3.5rem);
            color: #fff;
            margin-bottom: 30px;
            animation: fadeInUp 0.5s ease 0.2s forwards;
            opacity: 0;
        }

        .ending-narration {
            max-width: 600px;
            font-family: var(--font-serif);
            font-size: clamp(1rem, 2.5vw, 1.15rem);
            line-height: 2;
            color: var(--color-text);
            margin-bottom: 20px;
            animation: fadeInUp 0.5s ease 0.4s forwards;
            opacity: 0;
        }

        .ending-epilogue {
            font-style: italic;
            color: var(--color-text-dim);
            margin-bottom: 40px;
            animation: fadeInUp 0.5s ease 0.6s forwards;
            opacity: 0;
        }

        .ending-stats {
            max-width: 400px;
            width: 100%;
            padding: 20px;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid #333;
            border-radius: 12px;
            margin-bottom: 30px;
            animation: fadeInUp 0.5s ease 0.8s forwards;
            opacity: 0;
        }

        .ending-stats h4 {
            font-size: 0.85rem;
            color: var(--color-text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        .achievements {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .achievement {
            padding: 8px 15px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--color-gold);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--color-gold);
        }

        .restart-btn {
            animation: fadeInUp 0.5s ease 1s forwards;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           Message Toast
           ============================================ */
        .message-toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            padding: 12px 25px;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #444;
            border-radius: 10px;
            color: var(--color-text);
            font-size: 0.9rem;
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .message-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .message-toast.success {
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .message-toast.warning {
            border-color: var(--color-gold);
            color: var(--color-gold);
        }

        .message-toast.danger {
            border-color: var(--color-danger);
            color: var(--color-danger);
        }

        /* ============================================
           Save/Load Buttons
           ============================================ */
        .save-load-buttons {
            position: fixed;
            top: 80px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 80;
        }

        .save-load-btn {
            width: 44px;
            height: 44px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #333;
            border-radius: 10px;
            color: var(--color-text-dim);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .save-load-btn:hover {
            border-color: var(--color-blood);
            color: var(--color-text);
            transform: scale(1.1);
        }

        /* ============================================
           Mobile Responsiveness
           ============================================ */
        @media (max-width: 768px) {
            .status-bar {
                padding: 10px 15px;
                gap: 10px;
            }

            .stat {
                min-width: 100px;
            }

            .stat-value {
                display: none;
            }

            .narrative-area {
                padding: 20px 15px;
            }

            .narrative-box {
                padding: 20px;
            }

            .choices-area {
                padding: 15px;
            }

            .choice-btn {
                padding: 12px 15px;
            }

            .inventory-toggle {
                top: auto;
                bottom: 100px;
                right: 15px;
                width: 45px;
                height: 45px;
            }

            .save-load-buttons {
                top: auto;
                bottom: 100px;
                left: 15px;
            }

            .save-load-btn {
                width: 40px;
                height: 40px;
            }

            .fear-border-top,
            .fear-border-bottom {
                height: 100px;
            }

            .fear-border-left,
            .fear-border-right {
                width: 60px;
            }

            .flags-display {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .title-screen h1 {
                font-size: 1.8rem;
            }

            .btn {
                padding: 12px 35px;
                font-size: 1rem;
            }

            .stat {
                min-width: 80px;
            }

            .narrative-text {
                font-size: 0.95rem;
            }
        }

        /* ============================================
           Loading Animation
           ============================================ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: var(--color-blood);
            border-radius: 50%;
            animation: loadingPulse 1.4s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes loadingPulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.5); opacity: 1; }
        }

        /* ============================================
           Hallucination Text (High Fear)
           ============================================ */
        .hallucination {
            position: fixed;
            z-index: 95;
            font-family: var(--font-serif);
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            color: var(--color-blood);
            text-shadow: 0 0 20px var(--color-blood-glow);
            pointer-events: none;
            opacity: 0;
            animation: hallucinationFade 2s ease forwards;
        }

        @keyframes hallucinationFade {
            0% { opacity: 0; transform: scale(0.8); }
            20% { opacity: 0.8; transform: scale(1); }
            80% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.2); }
        }

        /* ============================================
           Rain Effect (CSS only)
           ============================================ */
        .rain-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .rain-container.active {
            opacity: 0.3;
        }

        .rain-drop {
            position: absolute;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.3));
            animation: rainFall linear infinite;
        }

        @keyframes rainFall {
            0% { transform: translateY(-100px); }
            100% { transform: translateY(100vh); }
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <!-- Vignette Effect -->
        <div class="vignette"></div>

        <!-- Fear Overlay -->
        <div class="fear-overlay" id="fearOverlay">
            <div class="fear-border-top"></div>
            <div class="fear-border-bottom"></div>
            <div class="fear-border-left"></div>
            <div class="fear-border-right"></div>
        </div>

        <!-- Flash Overlay -->
        <div class="flash-overlay" id="flashOverlay"></div>

        <!-- Rain Effect -->
        <div class="rain-container" id="rainContainer"></div>

        <!-- Title Screen -->
        <div class="screen title-screen active" id="titleScreen">
            <h1>åŠ å»å¤§é“çš„ç¬¬Nä½ä¹˜å®¢</h1>
            <p class="subtitle">The Nth Passenger on Karak Highway</p>

            <div class="warning">
                <div class="warning-title">âš ï¸ å…§å®¹è­¦å‘Š</div>
                <div class="warning-text">æœ¬éŠæˆ²åŒ…å«å¿ƒç†ææ‡¼ã€æ°‘ä¿—æ€ªè«‡ã€è¡€è…¥æè¿°ç­‰å…§å®¹ï¼Œå»ºè­°18æ­²ä»¥ä¸Šç©å®¶éŠç©ã€‚</div>
            </div>

            <button class="btn" onclick="startGame()">é–‹å§‹éŠæˆ²</button>

            <div class="credits">
                Aurora Green Studio Â· v1.0.0 Â· å¤¢é­˜å¼•æ“
            </div>
        </div>

        <!-- Game Screen -->
        <div class="screen game-screen" id="gameScreen">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="stat">
                    <span class="stat-icon">â¤ï¸</span>
                    <div class="stat-bar">
                        <div class="stat-fill health" id="healthBar" style="width: 100%"></div>
                    </div>
                    <span class="stat-value" id="healthValue">100</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">ğŸ‘ï¸</span>
                    <div class="stat-bar">
                        <div class="stat-fill sanity" id="sanityBar" style="width: 100%"></div>
                    </div>
                    <span class="stat-value" id="sanityValue">100</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">â˜¯ï¸</span>
                    <div class="stat-bar">
                        <div class="stat-fill karma" id="karmaBar" style="width: 50%"></div>
                    </div>
                    <span class="stat-value" id="karmaValue">50</span>
                </div>
            </div>

            <!-- Save/Load Buttons -->
            <div class="save-load-buttons">
                <button class="save-load-btn" onclick="saveGame()" title="å„²å­˜éŠæˆ²">ğŸ’¾</button>
                <button class="save-load-btn" onclick="loadGame()" title="è¼‰å…¥éŠæˆ²">ğŸ“‚</button>
            </div>

            <!-- Inventory Toggle -->
            <div class="inventory-toggle" onclick="toggleInventory()">
                ğŸ’
                <span class="inventory-badge" id="inventoryBadge">3</span>
            </div>

            <!-- Narrative Area -->
            <div class="narrative-area" id="narrativeArea">
                <div class="narrative-content">
                    <div class="scene-title" id="sceneTitle">åºç« </div>
                    <div class="narrative-box">
                        <div class="narrative-text" id="narrativeText"></div>
                    </div>
                    <div class="inner-monologue" id="innerMonologue" style="display: none;">
                        <div class="inner-monologue-label">å…§å¿ƒç¨ç™½</div>
                        <div class="inner-monologue-text" id="innerMonologueText"></div>
                    </div>
                </div>
            </div>

            <!-- Choices Area -->
            <div class="choices-area">
                <div class="choices-container" id="choicesContainer"></div>
                <div class="skip-hint" id="skipHint" style="display: none;">é»æ“Šç•«é¢è·³éæ–‡å­—å‹•ç•«</div>
            </div>

            <!-- Flags Display -->
            <div class="game-status">
                <div class="flags-display" id="flagsDisplay"></div>
            </div>
        </div>

        <!-- Ending Screen -->
        <div class="screen ending-screen" id="endingScreen">
            <div class="ending-type good" id="endingType">âœ¦ å–„çµ‚ âœ¦</div>
            <h1 class="ending-title" id="endingTitle">æ¯å­é‡é€¢</h1>
            <p class="ending-narration" id="endingNarration"></p>
            <p class="ending-epilogue" id="endingEpilogue"></p>

            <div class="ending-stats">
                <h4>ğŸ† æˆå°±è§£é–</h4>
                <div class="achievements" id="achievements"></div>
            </div>

            <button class="btn restart-btn" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
        </div>

        <!-- Inventory Panel -->
        <div class="inventory-overlay" id="inventoryOverlay" onclick="toggleInventory()"></div>
        <div class="inventory-panel" id="inventoryPanel">
            <div class="inventory-header">
                <h3>ğŸ’ èƒŒåŒ…</h3>
                <button class="inventory-close" onclick="toggleInventory()">Ã—</button>
            </div>
            <div class="inventory-items" id="inventoryItems"></div>
        </div>

        <!-- Message Toast -->
        <div class="message-toast" id="messageToast"></div>
    </div>

    <script>
        // ============================================
        // Game State
        // ============================================
        let gameState = {
            currentScene: 'start_01',
            stats: {
                sanity: 100,
                health: 100,
                karma: 50
            },
            inventory: [
                { id: 'phone', name: 'æ‰‹æ©Ÿ', desc: 'é›»é‡ 12%ï¼Œå®Œå…¨æ²’æœ‰è¨Šè™Ÿ', icon: 'ğŸ“±', battery: 12 },
                { id: 'water', name: 'ä¸€ç“¶æ°´', desc: 'æ™®é€šçš„ç¤¦æ³‰æ°´', icon: 'ğŸ’§' },
                { id: 'amulet', name: 'è­·èº«ç¬¦', desc: 'æœªé–‹å…‰', icon: 'ğŸ”®', charges: 0, blessed: false }
            ],
            flags: {
                has_prayed_datuk_kong: false,
                has_whistled_at_night: false,
                knows_pontianak_name: false,
                yellow_vw_sighted: false,
                grandma_appeared: false,
                knows_rest_method: false,
                in_loop: false,
                first_encounter: false
            },
            history: []
        };

        let isTyping = false;
        let typewriterTimeout = null;
        let currentText = '';
        let currentIndex = 0;

        // ============================================
        // Scene Data
        // ============================================
        const scenes = {
            'start_01': {
                title: 'æ·±å¤œ 02:33 Â· åŠ å»å¤§é“',
                text: `é›¨åˆ·ç˜‹ç‹‚åœ°æ“ºå‹•ï¼Œå»åˆ®ä¸æ·¨æ“‹é¢¨ç»ç’ƒå‰å¦‚ç€‘å¸ƒèˆ¬çš„æš´é›¨ã€‚ä½ èƒ½æ„Ÿè¦ºåˆ°è»Šå…§çš„ç©ºæ°£è®Šå¾—é»ç¨ ã€æ‚¶ç†±â€”â€”é‚£ç¨®åªæœ‰ç†±å¸¶æ‰æœ‰çš„ã€å½·å½¿è¢«äººç”¨æ¿•æ¯›å·¾æ‚ä½å£é¼»çš„çª’æ¯æ„Ÿã€‚

ä½ çš„è»Šï¼Œå°±åœ¨åŠ å»å¤§é“é‚£æ¢é™°åé æ’­çš„éš§é“å‰ï¼Œæ¯«ç„¡é è­¦åœ°<span class="highlight">æ‹‹éŒ¨</span>äº†ã€‚

å„€è¡¨æ¿ä¸Šçš„æ™‚é˜é–‹å§‹é–ƒçˆã€‚æ”¶éŸ³æ©Ÿè£¡åŸæœ¬æ’­æ”¾çš„é¦¬ä¾†æµè¡Œæ­Œè¢«ä¸€é™£åˆºè€³çš„ç™½å™ªéŸ³å–ä»£â€”â€”æ²™æ²™æ²™æ²™â€”â€”åƒæ˜¯æœ‰äººç”¨æŒ‡ç”²åˆ®éç”Ÿé½çš„éµæ¿ã€‚

ä½ ä¼¸æ‰‹æƒ³é—œæ‰æ”¶éŸ³æ©Ÿã€‚

å°±åœ¨é€™æ™‚â€”â€”

<span class="blood">å¾Œåº§å‚³ä¾†ä¸€é™£å¬°å…’çš„å“­è²ã€‚</span>

é‚£å“­è²å¾ˆè¿‘ã€‚å¾ˆè¿‘ã€‚å°±åƒ...å°±åœ¨ä½ çš„è€³å¾Œã€‚

ä½†ä½ è¨˜å¾—å¾ˆæ¸…æ¥šã€‚

ä½ æ˜¯<span class="highlight">ä¸€å€‹äºº</span>é–‹è»Šçš„ã€‚`,
                innerMonologue: 'é€™ä¸å¯èƒ½...æˆ‘æ˜æ˜æ˜¯ä¸€å€‹äºº...é‚£è²éŸ³æ˜¯å¾å“ªè£¡ä¾†çš„ï¼Ÿ',
                rain: true,
                choices: [
                    { text: 'å›é ­çœ‹å¾Œåº§', next: 'death_look_back', effect: { sanity: -100 }, condition: { sanity: '<50' } },
                    { text: 'èª¿æ•´å¾Œè¦–é¡è§€å¯Ÿ', next: 'mirror_check', effect: { sanity: -10 } },
                    { text: 'ç„¡è¦–è²éŸ³ï¼Œå˜—è©¦é‡æ–°ç™¼å‹•å¼•æ“', next: 'engine_start', effect: { karma: 5 } }
                ]
            },
            'mirror_check': {
                title: 'å¾Œè¦–é¡',
                text: `ä½ é¡«æŠ–è‘—èª¿æ•´å¾Œè¦–é¡ã€‚è—‰è‘—å¶çˆ¾åŠƒç ´å¤©éš›çš„é–ƒé›»ï¼Œä½ çœ‹åˆ°å¾Œåº§åè‘—ä¸€å€‹<span class="blood">ç©¿è‘—ç™½è¢çš„é•·é«®å¥³å­</span>ã€‚

å¥¹ä½è‘—é ­ï¼Œç©ºæ°£ä¸­çªç„¶ç€°æ¼«è‘—ä¸€è‚¡ç”œè†©å¾—ä»¤äººä½œå˜”çš„<span class="highlight">é›è›‹èŠ±é¦™ (Frangipani)</span>ã€‚

æ ¹æ“šå—æ´‹å‚³èªªï¼Œé€™æ˜¯ <span class="blood">Pontianak</span> å‡ºç¾çš„å¾µå…†ã€‚

å¥¹çš„é ­ï¼Œç·©ç·©åœ°æŠ¬èµ·ä¾†äº†......`,
                innerMonologue: 'ä¸è¦çœ‹å¥¹çš„è‡‰...é˜¿å¬¤èªªéï¼Œä¸è¦çœ‹å¥¹çš„è‡‰...',
                shake: true,
                effect: { sanity: -15 },
                choices: [
                    { text: 'é–‰ä¸Šçœ¼ç›ï¼Œå¿µèª¦è­·èº«å’’èª', next: 'chant_prayer', effect: { karma: 10 } },
                    { text: 'çŒ›è¸©æ²¹é–€ï¼Œä¸ç®¡å¼•æ“èƒ½ä¸èƒ½ç™¼å‹•', next: 'engine_escape', effect: { sanity: -5 } },
                    { text: 'è·³è»Šé€ƒè·‘', next: 'jump_out', effect: { health: -20, sanity: -10 } }
                ]
            },
            'engine_start': {
                title: 'å¼•æ“',
                text: `ä½ å’¬ç·Šç‰™é—œã€‚

<span class="malay">ä¸è¦å›é ­ã€‚ä¸è¦å›é ­ã€‚Jangan pandang belakang.</span>

é€™æ˜¯ä½ é˜¿å¬¤å¾å°å°±å”¸å¨çš„è©±ã€‚è€äººå®¶èªªï¼Œå¤œè·¯ä¸Šè½åˆ°å¥‡æ€ªçš„è²éŸ³ï¼Œ<span class="highlight">åƒè¬ä¸è¦å›é ­</span>ã€‚ä½ å›é ­ï¼Œå°±æ˜¯çµ¦ã€Œç¥‚ã€é–‹é–€ã€‚

ä½ å¼·è¿«è‡ªå·±çš„è¦–ç·šé‡˜åœ¨å‰æ–¹çš„æ“‹é¢¨ç»ç’ƒä¸Šã€‚é‘°åŒ™è½‰å‹•ã€‚å¼•æ“ç™¼å‡ºä¸€è²å˜¶å•çš„å’³å—½ã€‚

ã€Œå’”å—’ã€‚å’”å—’ã€‚å’”å—’ã€‚ã€

æ²’æœ‰åæ‡‰ã€‚

å¾Œåº§çš„å“­è²<span class="blood">åœäº†</span>ã€‚

åœå¾—å¤ªçªç„¶äº†ã€‚

ç„¶å¾Œï¼Œä½ è½åˆ°äº†<span class="highlight">å‘¼å¸è²</span>ã€‚å°±åœ¨ä½ çš„é ¸å¾Œã€‚æº«ç†±çš„ã€æ½®æ¿•çš„æ°£æ¯ï¼Œè¼•è¼•æ‹‚éä½ çš„å¾Œé ¸......`,
                innerMonologue: 'å¥¹...å°±åœ¨æˆ‘èº«å¾Œ...',
                effect: { sanity: -10, karma: 5 },
                setFlag: { yellow_vw_sighted: true },
                choices: [
                    { text: 'ç¹¼çºŒå˜—è©¦ç™¼å‹•å¼•æ“', next: 'engine_success', effect: { karma: 5 } },
                    { text: 'ç·©ç·©è½‰é ­', next: 'turn_around', effect: { sanity: -30 } },
                    { text: 'å¿µèª¦å…­å­—å¤§æ˜å’’', next: 'chant_prayer', effect: { sanity: 10, karma: 10 } }
                ]
            },
            'chant_prayer': {
                title: 'å’’èª',
                text: `ä½ é–‰ä¸Šçœ¼ç›ï¼Œå˜´å”‡é¡«æŠ–è‘—åå‡ºé‚£äº›å¡µå°å·²ä¹…çš„å­—å¥ï¼š

<span class="malay">ã€Œå”µã€‚å˜›ã€‚å‘¢ã€‚å­ã€‚å’ªã€‚å½ã€‚ã€</span>

å…­å­—å¤§æ˜å’’ã€‚

ä½ ä¸€éåˆä¸€éåœ°å¿µèª¦ã€‚è²éŸ³å¾é¡«æŠ–è®Šå¾—å¹³ç©©ï¼Œå¾å¹³ç©©è®Šå¾—å …å®šã€‚

ç©ºæ°£ä¸­çš„èŠ±é¦™é–‹å§‹<span class="highlight">æ¶ˆé€€</span>ã€‚ä½ æ„Ÿè¦ºåˆ°èƒ¸å£çš„è­·èº«ç¬¦é–‹å§‹ç™¼ç‡™â€”â€”ä¸€ç¨®æº«æš–çš„ã€åƒè¢«äººæ¡ä½æ‰‹çš„å®‰å¿ƒæ„Ÿã€‚

æ”¶éŸ³æ©Ÿçš„æ²™æ²™è²è®Šäº†ã€‚è®Šæˆäº†ä¸€å€‹è€å©¦äººçš„è²éŸ³ã€‚æ²™å•ï¼Œä½†æº«å’Œã€‚ç†Ÿæ‚‰å¾—è®“ä½ çœ¼çœ¶ä¸€ç†±ã€‚

<span class="ghost">ã€Œå­«ä»”...é˜¿å¬¤åœ¨é€™è£¡...ã€</span>

ä¸å¯èƒ½ã€‚é˜¿å¬¤ä¸‰å¹´å‰å°±éä¸–äº†ã€‚

<span class="ghost">ã€Œå‰é¢æœ‰é–“åœŸåœ°å»Ÿ...å»æ‹œæ‹œ...ç¥‚æœƒå¹«ä½ çš„...ã€</span>
<span class="ghost">ã€Œè¨˜ä½...ä¸è¦å‘Šè¨´ç¥‚ä½ çš„åå­—...ä¸è¦çœ‹ç¥‚çš„çœ¼ç›...ã€</span>

è²éŸ³æ¶ˆå¤±äº†ã€‚ä½ çœé–‹çœ¼ã€‚

<span class="highlight">é›¨åœäº†ã€‚</span>

ä½ é¢å‰å‡ºç¾äº†ä¸€æ¢<span class="highlight">å²”è·¯</span>ã€‚å·¦é‚Šé€šå‘ä¸€åº§ç´…è‰²çš„ç¥é¾•ï¼Œå³é‚Šæ˜¯åŠ å»å¤§é“çš„å»¶çºŒã€‚`,
                innerMonologue: 'é˜¿å¬¤...çœŸçš„æ˜¯ä½ å—ï¼Ÿ',
                effect: { sanity: 20, karma: 15 },
                setFlag: { grandma_appeared: true },
                blessAmulet: true,
                choices: [
                    { text: 'å·¦è½‰ï¼Œå‰å¾€åœŸåœ°å…¬ç¥é¾•', next: 'shrine_approach', effect: { karma: 10 } },
                    { text: 'å³è½‰ï¼Œç¹¼çºŒèµ°å¤§è·¯', next: 'highway_continue', effect: { sanity: -5 } },
                    { text: 'ä¸‹è»Šæ­¥è¡Œ', next: 'walk_outside', effect: { health: -5 } }
                ]
            },
            'shrine_approach': {
                title: 'æ‹¿ç£å…¬ç¥é¾•',
                text: `ä½ çš„è»Šåœ¨ä¸€æ£µå·¨å¤§çš„è€æ¦•æ¨¹å‰åœä¸‹ã€‚

æ¦•æ¨¹çš„æ°£æ ¹å‚è½å¦‚ç°¾ï¼Œæ¨¹å¹¹ç²—å¾—è¦äº”å…­å€‹äººæ‰èƒ½ç’°æŠ±ã€‚æ¨¹ä¸‹ï¼Œå°±æ˜¯é‚£åº§<span class="highlight">ç¥é¾•</span>ã€‚

ç´…æ¼†æœ¨è£½çš„å°å»Ÿï¼Œé¾•å…§ä¾›è‘—ä¸€å°Šå°å°çš„ç¥åƒâ€”â€”ä¸€ä½ç•™è‘—ç™½é¬å­çš„è€è€…ï¼Œç©¿è‘—é¦¬ä¾†å‚³çµ±æœé£¾ï¼Œé ­æˆ´å®‹è°·å¸½ã€‚ç¥åƒå‰æ“ºè‘—å¹¾å€‹æ©˜å­ã€ä¸€åŒ…é¦™ç…™ã€å¹¾æ ¹ç‡ƒç›¡çš„é¦™ã€‚

æœ€è©­ç•°çš„æ˜¯â€”â€”ç¥é¾•å‰çš„å…©æ ¹ç´…è Ÿç‡­ï¼Œåœ¨ç„¡é¢¨çš„å¤œè£¡ï¼Œ<span class="highlight">ç©©ç©©åœ°ç‡ƒç‡’è‘—</span>ã€‚

ä½ ç«™åœ¨ç¥é¾•å‰ã€‚ç©ºæ°£ä¸­ç€°æ¼«è‘—<span class="malay">ç”˜æ–‡ç…™ (Kemenyan)</span> çš„æ°£å‘³ã€‚

ç„¶å¾Œï¼Œä½ è½åˆ°äº†ä¸€å€‹è²éŸ³ã€‚ä½æ²‰ã€‚è’¼è€ã€‚

<span class="ghost">ã€Œå­©å­...ä½ ä¾†é€™è£¡...åšä»€éº¼...ã€</span>`,
                innerMonologue: 'ç¥‚åœ¨è·Ÿæˆ‘èªªè©±...é€™æ˜¯æ‹¿ç£å…¬å—ï¼Ÿ',
                effect: { sanity: 10 },
                choices: [
                    { text: 'è·ªä¸‹ç¥ˆç¦±ï¼Œè«‹æ±‚åº‡è­·', next: 'pray_datuk', effect: { sanity: 30, karma: 20 } },
                    { text: 'ç»ä¸Šæ°´ä½œç‚ºä¾›å“', next: 'offer_water', effect: { sanity: 25, karma: 15 } },
                    { text: 'è¦ºå¾—æ˜¯å¹»è¦ºï¼Œè½‰èº«é›¢é–‹', next: 'leave_shrine', effect: { sanity: -20, karma: -30 } }
                ],
                freeInput: true,
                freeInputHint: 'ä½ ä¹Ÿå¯ä»¥è¼¸å…¥æƒ³èªªçš„è©±æˆ–æƒ³åšçš„äº‹...'
            },
            'pray_datuk': {
                title: 'æ‹¿ç£å…¬çš„ç¥ç¦',
                text: `ä½ é›™è†è·ªå…¥æ³¥æ¿˜ä¹‹ä¸­ï¼Œé›™æ‰‹åˆåï¼š

ã€Œæ‹¿ç£å…¬åœ¨ä¸Š...ä¿¡å¾’è¿·è·¯æ–¼æ­¤ï¼Œé­é€¢é‚ªç¥Ÿçºèº«...æ‡‡è«‹æ‹¿ç£å…¬æ…ˆæ‚²åº‡è­·...ã€

æ²‰é»˜ã€‚æ¼«é•·çš„æ²‰é»˜ã€‚

ç„¶å¾Œâ€”â€”è Ÿç‡­çš„ç«ç„°çªç„¶<span class="highlight">æš´æ¼²</span>ã€‚

<span class="ghost">ã€Œæ¸…æ°´æ½”æ·¨ã€‚å¿ƒæ„ç´”æ­£ã€‚ã€</span>

ä¸€é“ç„¡å½¢çš„åŠ›é‡å¾ç¥é¾•ä¸­æ¹§å‡ºã€‚ä½ æ„Ÿè¦ºåˆ°èƒ¸å£çš„è­·èº«ç¬¦çªç„¶<span class="highlight">ç¼ç†±</span>â€”â€”æŸç¨®èƒ½é‡æ­£åœ¨æ³¨å…¥ã€‚

<span class="ghost">ã€Œè­·èº«ç¬¦å·²é–‹å…‰ã€‚èƒ½æ“‹ä¸‰æ¬¡é‚ªç¥Ÿä¾µè¥²ã€‚ä½†åªæœ‰ä¸‰æ¬¡ã€‚ã€</span>

<span class="ghost">ã€Œé‚£å€‹å¥³äºº...å¥¹å«ã€çµ²è’‚ã€...ç”Ÿå‰æ˜¯é€™æ¢è·¯ä¸Šçš„æ–°å¨˜ï¼Œæ­»æ–¼é›£ç”¢...ã€</span>

<span class="ghost">ã€Œå¥¹åœ¨æ‰¾å¥¹çš„å­©å­ã€‚æ‰¾äº†ä¸ƒåå¹´ã€‚ã€</span>

<span class="ghost">ã€Œå‘Šè¨´å¥¹â€”â€”å­©å­åœ¨ã€æ¦•æ¨¹ä¸‹çš„ç¬¬ä¸ƒæ£µå¢³ã€ã€‚ã€</span>

<span class="ghost">ã€Œé€™æ˜¯å”¯ä¸€èƒ½è®“å¥¹å®‰æ¯çš„æ–¹æ³•ã€‚ã€</span>

é¢¨çªç„¶åœäº†ã€‚é è™•ï¼Œä¸€å€‹<span class="blood">ç™½è‰²çš„èº«å½±</span>ç«™åœ¨è·¯é‚Šçš„æ¨¹ä¸‹......`,
                innerMonologue: 'çµ²è’‚...ä¸ƒåå¹´...å¥¹åªæ˜¯æƒ³æ‰¾å¥¹çš„å­©å­...',
                effect: { sanity: 30, karma: 25 },
                setFlag: { has_prayed_datuk_kong: true, knows_pontianak_name: true, knows_rest_method: true },
                blessAmulet: true,
                amuletCharges: 3,
                flash: '#d4af37',
                choices: [
                    { text: 'å°å¥¹èªªï¼šã€Œçµ²è’‚...ä½ çš„å­©å­åœ¨æ¦•æ¨¹ä¸‹çš„ç¬¬ä¸ƒæ£µå¢³ã€‚ã€', next: 'tell_siti_truth', effect: { karma: 30 } },
                    { text: 'æ¡ç·Šè­·èº«ç¬¦ï¼Œæ…¢æ…¢ç¹éå¥¹', next: 'sneak_past', effect: { sanity: -15 } },
                    { text: 'è¡å‘è»Šå­é€ƒè·‘', next: 'run_to_car', effect: { sanity: -20, health: -10 } }
                ]
            },
            'sneak_past': {
                title: 'è­·èº«ç¬¦çš„å®ˆè­·',
                text: `ä½ æ¡ç·Šè­·èº«ç¬¦ï¼Œé–‹å§‹ç·©æ…¢ç§»å‹•ã€‚

ä¸€å°æ­¥ã€‚åˆä¸€å°æ­¥ã€‚

å¥¹çš„é ­å‹•äº†ã€‚ã€Œå˜å±â€”â€”ã€åƒæ˜¯ç”Ÿé½çš„é½’è¼ªè½‰å‹•çš„è²éŸ³ã€‚

ç„¶å¾Œâ€”â€”<span class="blood">å¥¹ç¬ç§»åˆ°ä½ é¢å‰</span>ã€‚

ä½ çš„è­·èº«ç¬¦<span class="highlight">çˆ†ç™¼å‡ºé‡‘å…‰</span>ï¼

ã€Œå˜¶å˜¶å˜¶å˜¶â€”â€”ï¼ã€å¥¹ç™¼å‡ºæ·’å²çš„å°–å˜¯ï¼Œåƒæ˜¯è¢«ç‡™å‚·äº†ä¸€æ¨£å‘å¾Œé€€å»ã€‚

ä½ çœ‹åˆ°äº†å¥¹çš„è‡‰â€”â€”è’¼ç™½å¦‚è Ÿï¼Œå˜´å·´è£‚é–‹åˆ°è€³æ ¹ã€‚ä½†æœ€å¯æ€•çš„æ˜¯å¥¹çš„è¡¨æƒ…ã€‚

ä¸æ˜¯æ†¤æ€’ã€‚æ˜¯<span class="highlight">æ‚²å‚·</span>ã€‚ä¸€ç¨®æ·±å…¥éª¨é«“çš„ã€çµ•æœ›çš„æ‚²å‚·ã€‚

è­·èº«ç¬¦çš„å…‰èŠ’é»¯æ·¡äº†ã€‚<span class="highlight">å‰©é¤˜å…©æ¬¡ã€‚</span>

å¥¹ç«™åœ¨åŸåœ°ï¼Œå˜´å”‡å‹•è‘—ï¼š

<span class="ghost">ã€ŒTolong... cari anak aku...ã€</span>
<span class="ghost">ã€Œæ±‚æ±‚ä½ ...å¹«æˆ‘æ‰¾æˆ‘çš„å­©å­...ã€</span>`,
                innerMonologue: 'å¥¹ä¸æ˜¯è¦æ®ºæˆ‘...å¥¹åªæ˜¯æƒ³æ‰¾å¥¹çš„å­©å­...',
                effect: { sanity: -15 },
                useAmuletCharge: true,
                setFlag: { first_encounter: true },
                shake: true,
                flash: '#d4af37',
                choices: [
                    { text: 'å°‹æ‰¾ã€Œæ¦•æ¨¹ä¸‹çš„ç¬¬ä¸ƒæ£µå¢³ã€', next: 'search_grave', effect: { karma: 20 } },
                    { text: 'é€ƒå›è»Šä¸Šï¼Œå„˜å¿«é›¢é–‹', next: 'escape_ending', effect: { sanity: -10 } },
                    { text: 'å‘Šè¨´å¥¹å­©å­çš„ä½ç½®', next: 'tell_siti_truth', effect: { karma: 30 } }
                ]
            },
            'search_grave': {
                title: 'ç¬¬ä¸ƒæ£µå¢³',
                text: `ä½ é§›å…¥æ›´æ·±çš„å¢æ—å°è·¯ï¼Œç›´åˆ°è»Šç‡ˆç…§äº®äº†ä¸€ç‰‡å¤è€çš„<span class="highlight">å¢“åœ°</span>ã€‚

å¢“ç¢‘æ±å€’è¥¿æ­ªï¼Œè¢«è—¤è”“è¦†è“‹ã€‚ç©ºåœ°ä¸­å¤®ï¼Œä¸€æ£µå·¨å¤§çš„æ¦•æ¨¹ã€‚

ä½ é–‹å§‹æ•¸å¢“ç¢‘ã€‚

ç¬¬ä¸€æ£µ...ç¬¬äºŒæ£µ...ç¬¬ä¸‰æ£µ...

ç¬¬ä¸ƒæ£µå¢“ç¢‘å°±åœ¨æ¦•æ¨¹çš„æ°£æ ¹ä¹‹é–“ã€‚å®ƒå¾ˆå°ã€‚åƒæ˜¯â€”â€”åƒæ˜¯ä¸€å€‹<span class="highlight">å¬°å…’çš„å¢³å¢“</span>ã€‚

ç¢‘ä¸Šçš„å­—è·¡ï¼š

<span class="highlight">ã€Œç„¡åå¬°å­©ä¹‹å¢“ã€</span>
<span class="highlight">ã€Œç”Ÿæ–¼æ°‘åœ‹ä¸‰åäºŒå¹´ã€</span>
<span class="highlight">ã€Œå’æ–¼æ°‘åœ‹ä¸‰åäºŒå¹´ã€</span>

1943å¹´ã€‚æ—¥æ“šæ™‚æœŸã€‚

ä½ èº«å¾Œå‚³ä¾†è…³æ­¥è²ã€‚é‚£è‚¡é›è›‹èŠ±çš„é¦™æ°£å†æ¬¡ç€°æ¼«â€”â€”ä½†é€™æ¬¡ï¼Œæ²’æœ‰é‚£éº¼è…è‡­ã€‚

å¥¹å°±ç«™åœ¨ä½ èº«å¾Œã€‚

ä½ é–‹å£ï¼šã€Œçµ²è’‚...æˆ‘æ‰¾åˆ°äº†...ä½ çš„å­©å­...å°±åœ¨é€™è£¡...ã€`,
                innerMonologue: 'ä¸ƒåå¹´...å¥¹æ‰¾äº†ä¸ƒåå¹´çš„å­©å­ï¼Œä¸€ç›´éƒ½åœ¨é€™è£¡...',
                effect: { sanity: 10, karma: 20 },
                choices: [
                    { text: 'è®“é–‹ï¼Œè®“å¥¹çœ‹åˆ°å¢³å¢“', next: 'ending_good', effect: { karma: 30 } }
                ]
            },
            'tell_siti_truth': {
                title: 'çœŸç›¸',
                text: `ä½ é¼“èµ·å‹‡æ°£ï¼Œå°è‘—é‚£å€‹ç™½è‰²çš„èº«å½±èªªï¼š

ã€Œçµ²è’‚...ä½ çš„å­©å­åœ¨æ¦•æ¨¹ä¸‹çš„ç¬¬ä¸ƒæ£µå¢³ã€‚ä»–ä¸€ç›´éƒ½åœ¨é‚£è£¡...ç­‰ä½ ...ã€

å¥¹åœæ­¢äº†ç§»å‹•ã€‚

é‚£å¼µç ´ç¢çš„è‡‰ä¸Šï¼Œç©ºæ´çš„çœ¼çœ¶ä¸­ï¼Œä¼¼ä¹æœ‰ä»€éº¼æ±è¥¿åœ¨é–ƒçˆã€‚

<span class="ghost">ã€Œ...anak aku...?ã€</span>
<span class="ghost">ã€Œ...æˆ‘çš„å­©å­...?ã€</span>

å¥¹çš„èº«å½±é–‹å§‹è®ŠåŒ–ã€‚ä¸å†æ˜¯ææ€–çš„å²é¬¼â€”â€”é•·é«®ä¾èˆŠï¼Œä½†ä¸å†å‡Œäº‚ï¼›ç™½è¢ä¾èˆŠï¼Œä½†ä¸å†æ²¾æ»¿è¡€æ±¡ã€‚

å¥¹çœ‹èµ·ä¾†åƒä¸€å€‹æ™®é€šçš„é¦¬ä¾†å°‘å¥³ã€‚å¹´è¼•ï¼Œç¾éº—ï¼Œå»æ»¿è‡‰æ·šç—•ã€‚

<span class="ghost">ã€Œå¸¶æˆ‘å»...æ±‚æ±‚ä½ ...å¸¶æˆ‘å»è¦‹ä»–...ã€</span>`,
                innerMonologue: 'å¥¹ç›¸ä¿¡æˆ‘äº†...æˆ‘å¯ä»¥å¹«åŠ©å¥¹...',
                effect: { sanity: 20, karma: 30 },
                choices: [
                    { text: 'å¸¶å¥¹å‰å¾€å¢“åœ°', next: 'ending_good', effect: { karma: 30 } }
                ]
            },
            'ending_good': {
                title: 'é‡é€¢',
                text: `å¥¹è·ªåœ¨é‚£åº§å°å°çš„å¢³å¢“å‰ã€‚

<span class="malay">ã€ŒAnak aku... anak aku...ã€</span>
<span class="ghost">ã€Œæˆ‘çš„å­©å­...æˆ‘çš„å­©å­...ã€</span>

<span class="malay">ã€ŒMaafkan ibu... ibu datang lambat...ã€</span>
<span class="ghost">ã€ŒåŸè«’åª½åª½...åª½åª½ä¾†é²äº†...ã€</span>

å¢“ç¢‘é–‹å§‹ç™¼å…‰ã€‚å¾®å¼±çš„ã€æº«æš–çš„é‡‘å…‰ã€‚

å¥¹æŠ¬èµ·é ­ï¼Œçœ‹å‘ä½ ã€‚ä¸æ˜¯ç©ºæ´çš„çœ¼çœ¶ï¼Œä¸æ˜¯è£‚é–‹çš„å˜´ã€‚æ˜¯ä¸€å¼µå¹´è¼•çš„è‡‰ï¼Œå¸¶è‘—æ·šæ°´ï¼Œä½†ä¹Ÿå¸¶è‘—<span class="highlight">ç¬‘å®¹</span>ã€‚

<span class="malay">ã€ŒTerima kasih...ã€</span>
<span class="ghost">ã€Œè¬è¬ä½ ...ã€</span>

å…‰èŠ’è¶Šä¾†è¶Šäº®â€”â€”

ç•¶ä½ å†æ¬¡çœé–‹çœ¼æ™‚ï¼Œå¥¹ä¸è¦‹äº†ã€‚

å¢³å¢“å‰å¤šäº†ä¸€æš<span class="highlight">éŠ€è‰²çš„è…³éˆ</span>å’Œä¸€æœµæ–°é®®çš„<span class="highlight">é›è›‹èŠ±</span>ã€‚

å¤©é‚Šï¼Œå‡ºç¾äº†ä¸€çµ²é­šè‚šç™½ã€‚

<span class="highlight">é»æ˜äº†ã€‚</span>`,
                ending: true,
                endingType: 'good',
                endingTitle: 'æ¯å­é‡é€¢',
                endingNarration: 'ä½ é¸æ“‡äº†å¹«åŠ©ï¼Œè€Œéé€ƒé¿ã€‚ä½ è®“ä¸€å€‹å¾˜å¾Šä¸ƒåå¹´çš„éˆé­‚å¾—åˆ°å®‰æ¯ã€‚',
                endingEpilogue: 'ä¹Ÿè¨±åœ¨æŸå€‹æ·±å¤œï¼Œç•¶ä½ å†æ¬¡ç¶“éåŠ å»å¤§é“æ™‚ï¼Œä½ æœƒæƒ³èµ·é‚£æœµæ½”ç™½çš„é›è›‹èŠ±ã€‚',
                achievements: ['è¶…æ¸¡è€…', 'æ‹¿ç£å…¬çš„ä¿¡å¾’', 'é˜¿å¬¤çš„å¥½å­«å­', 'æ…ˆæ‚²å¿ƒ']
            },
            'escape_ending': {
                title: 'é€ƒé›¢',
                text: `ä½ ç™¼å‹•å¼•æ“ï¼ŒçŒ›è¸©æ²¹é–€ï¼Œè»Šå­å‘¼å˜¯è‘—è¡å‡ºå¢æ—ã€‚

ä½ ä¸€ç›´é–‹ï¼Œä¸€ç›´é–‹ï¼Œç›´åˆ°çœ‹åˆ°é«˜é€Ÿå…¬è·¯çš„ç‡ˆå…‰ã€‚

å›é ­æœ›å»ï¼Œåªæœ‰é»‘æš—ã€‚

ä½ é€ƒå‡ºä¾†äº†ã€‚

ä½†æ¯ç•¶æ·±å¤œï¼Œç•¶ä½ èåˆ°é›è›‹èŠ±çš„é¦™æ°£æ™‚ï¼Œä½ ç¸½æœƒæƒ³èµ·é‚£é›™ç©ºæ´çš„çœ¼ç›ï¼Œå’Œé‚£å¥è¼•è¼•çš„è«‹æ±‚ï¼š

<span class="ghost">ã€Œå¹«æˆ‘æ‰¾æˆ‘çš„å­©å­...ã€</span>

ä½ çŸ¥é“ï¼Œå¥¹é‚„åœ¨é‚£è£¡ã€‚

ç­‰å¾…è‘—ã€‚

æ°¸é ç­‰å¾…è‘—ã€‚`,
                ending: true,
                endingType: 'neutral',
                endingTitle: 'æœªå®Œçš„åŸ·å¿µ',
                endingNarration: 'ä½ é¸æ“‡äº†é€ƒè·‘ã€‚ä½ æ´»ä¸‹ä¾†äº†ï¼Œä½†é‚£å€‹æ‚²å‚·çš„éˆé­‚ä¾ç„¶åœ¨åŠ å»å¤§é“ä¸Šå¾˜å¾Šã€‚',
                endingEpilogue: 'ä¹Ÿè¨±æœ‰ä¸€å¤©ï¼Œæœƒæœ‰å¦ä¸€å€‹äººè½åˆ°å¥¹çš„è«‹æ±‚ã€‚',
                achievements: ['ç”Ÿé‚„è€…']
            },
            'death_look_back': {
                title: 'å›é ­',
                text: `ä½ å›é ­äº†ã€‚

å¥¹å°±åœ¨é‚£è£¡ã€‚

è‡‰è²¼è‘—è‡‰ã€‚

ä½ èƒ½æ„Ÿè¦ºåˆ°å¥¹å†°å†·çš„å‘¼å¸ã€‚èƒ½èåˆ°è…çˆ›çš„èŠ±é¦™ã€‚èƒ½çœ‹åˆ°é‚£å¼µ<span class="blood">è£‚é–‹çš„å˜´</span>ï¼Œä¸€ç›´è£‚åˆ°è€³æ ¹ã€‚

å¥¹ç¬‘äº†ã€‚

ã€Œ<span class="blood">æ‰¾åˆ°ä½ äº†ã€‚</span>ã€

ç„¶å¾Œâ€”â€”

<span class="blood">ä¸€åˆ‡æ­¸æ–¼é»‘æš—ã€‚</span>`,
                ending: true,
                endingType: 'bad',
                endingTitle: 'ç¬¬Nä½ä¹˜å®¢',
                endingNarration: 'ä½ æˆç‚ºäº†åŠ å»å¤§é“ä¸Šçš„åˆä¸€å€‹å‚³èªªã€‚åˆä¸€å€‹æ°¸é ç„¡æ³•åˆ°é”ç›®çš„åœ°çš„ä¹˜å®¢ã€‚',
                endingEpilogue: 'æ“šèªªåœ¨æ·±å¤œçš„åŠ å»å¤§é“ä¸Šï¼Œæœ‰æ™‚æœƒçœ‹åˆ°ä¸€è¼›æ‹‹éŒ¨çš„è»Šã€‚è»Šè£¡åè‘—ä¸€å€‹äººï¼Œè‡‰ä¸Šå¸¶è‘—ææ‡¼çš„è¡¨æƒ…ï¼Œæ°¸é å®šæ ¼åœ¨å›é ­çš„é‚£ä¸€ç¬é–“ã€‚',
                achievements: ['ä¸è½å‹¸å‘Š']
            }
        };

        // ============================================
        // Game Functions
        // ============================================

        function startGame() {
            document.getElementById('titleScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            loadScene('start_01');
            createRainDrops();
        }

        function loadScene(sceneId) {
            const scene = scenes[sceneId];
            if (!scene) {
                console.error('Scene not found:', sceneId);
                return;
            }

            gameState.currentScene = sceneId;
            gameState.history.push(sceneId);

            // Apply effects
            if (scene.effect) {
                applyEffects(scene.effect);
            }

            // Set flags
            if (scene.setFlag) {
                Object.assign(gameState.flags, scene.setFlag);
            }

            // Bless amulet
            if (scene.blessAmulet) {
                const amulet = gameState.inventory.find(i => i.id === 'amulet');
                if (amulet) {
                    amulet.blessed = true;
                    amulet.desc = 'å·²é–‹å…‰';
                    amulet.charges = scene.amuletCharges || 3;
                    showMessage('è­·èº«ç¬¦å·²é–‹å…‰ï¼', 'success');
                }
            }

            // Use amulet charge
            if (scene.useAmuletCharge) {
                const amulet = gameState.inventory.find(i => i.id === 'amulet');
                if (amulet && amulet.charges > 0) {
                    amulet.charges--;
                    showMessage(`è­·èº«ç¬¦æŠµæ“‹äº†æ”»æ“Šï¼å‰©é¤˜ ${amulet.charges} æ¬¡`, 'warning');
                }
            }

            // Visual effects
            if (scene.shake) {
                triggerShake();
            }
            if (scene.flash) {
                triggerFlash(scene.flash);
            }
            if (scene.rain) {
                document.getElementById('rainContainer').classList.add('active');
            } else {
                document.getElementById('rainContainer').classList.remove('active');
            }

            // Update UI
            document.getElementById('sceneTitle').textContent = scene.title;
            updateStats();
            updateFlags();
            updateInventory();
            updateFearEffect();

            // Clear choices
            document.getElementById('choicesContainer').innerHTML = '';
            document.getElementById('innerMonologue').style.display = 'none';

            // Check for ending
            if (scene.ending) {
                setTimeout(() => showEnding(scene), 2000);
            }

            // Typewriter effect
            typewriterEffect(scene.text, () => {
                if (scene.innerMonologue) {
                    document.getElementById('innerMonologue').style.display = 'block';
                    document.getElementById('innerMonologueText').textContent = scene.innerMonologue;
                }
                if (!scene.ending) {
                    showChoices(scene.choices, scene.freeInput, scene.freeInputHint);
                }
            });
        }

        function typewriterEffect(text, callback) {
            const container = document.getElementById('narrativeText');
            container.innerHTML = '';
            isTyping = true;
            currentText = text;
            currentIndex = 0;

            document.getElementById('skipHint').style.display = 'block';

            function type() {
                if (currentIndex < currentText.length) {
                    // Handle HTML tags
                    if (currentText[currentIndex] === '<') {
                        const closeIndex = currentText.indexOf('>', currentIndex);
                        if (closeIndex !== -1) {
                            container.innerHTML += currentText.substring(currentIndex, closeIndex + 1);
                            currentIndex = closeIndex + 1;
                        }
                    } else {
                        container.innerHTML += currentText[currentIndex];
                        currentIndex++;
                    }

                    // Trigger effects for certain words
                    const lastChars = container.textContent.slice(-10);
                    if (lastChars.includes('è¡€') || lastChars.includes('æ­»') || lastChars.includes('é¬¼')) {
                        if (Math.random() < 0.3) triggerShake();
                    }

                    const delay = currentText[currentIndex - 1]?.match(/[ã€‚ï¼Œï¼ï¼Ÿã€]/) ? 150 : 30;
                    typewriterTimeout = setTimeout(type, delay);
                } else {
                    isTyping = false;
                    document.getElementById('skipHint').style.display = 'none';
                    if (callback) callback();
                }
            }

            type();
        }

        function skipTypewriter() {
            if (isTyping) {
                clearTimeout(typewriterTimeout);
                document.getElementById('narrativeText').innerHTML = currentText;
                isTyping = false;
                document.getElementById('skipHint').style.display = 'none';

                const scene = scenes[gameState.currentScene];
                if (scene.innerMonologue) {
                    document.getElementById('innerMonologue').style.display = 'block';
                    document.getElementById('innerMonologueText').textContent = scene.innerMonologue;
                }
                if (!scene.ending) {
                    showChoices(scene.choices, scene.freeInput, scene.freeInputHint);
                }
            }
        }

        function showChoices(choices, freeInput, freeInputHint) {
            const container = document.getElementById('choicesContainer');
            container.innerHTML = '';

            choices.forEach((choice, index) => {
                // Check conditions
                if (choice.condition) {
                    const [stat, op, value] = Object.entries(choice.condition)[0];
                    const statValue = gameState.stats[stat.replace('<', '').replace('>', '')];
                    if (op === '<' && statValue >= parseInt(value)) return;
                    if (op === '>' && statValue <= parseInt(value)) return;
                }

                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerHTML = `<span class="choice-number">${index + 1}.</span><span class="choice-text">${choice.text}</span>`;
                btn.onclick = () => {
                    if (choice.effect) applyEffects(choice.effect);
                    loadScene(choice.next);
                };
                container.appendChild(btn);
            });

            // Free input
            if (freeInput) {
                const inputContainer = document.createElement('div');
                inputContainer.className = 'free-input-container';
                inputContainer.innerHTML = `
                    <div class="free-input-hint">ğŸ’¡ ${freeInputHint || 'ä½ ä¹Ÿå¯ä»¥è¼¸å…¥æƒ³èªªçš„è©±...'}</div>
                    <div class="free-input-wrapper">
                        <input type="text" class="free-input" id="freeInput" placeholder="è¼¸å…¥ä½ çš„è¡Œå‹•...">
                        <button class="submit-btn" onclick="handleFreeInput()">ç¢ºèª</button>
                    </div>
                `;
                container.appendChild(inputContainer);

                document.getElementById('freeInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleFreeInput();
                });
            }
        }

        function handleFreeInput() {
            const input = document.getElementById('freeInput').value.toLowerCase();
            if (!input.trim()) return;

            // Parse input for keywords
            if (input.includes('ç¥ˆç¦±') || input.includes('æ‹œ') || input.includes('æ±‚')) {
                loadScene('pray_datuk');
            } else if (input.includes('æ°´') || input.includes('ä¾›å“') || input.includes('ç»')) {
                applyEffects({ karma: 10 });
                loadScene('pray_datuk');
            } else if (input.includes('é›¢é–‹') || input.includes('èµ°')) {
                loadScene('leave_shrine');
            } else {
                showMessage('ä½ çš„è¡Œå‹•æ²’æœ‰ç”¢ç”Ÿç‰¹åˆ¥çš„æ•ˆæœ...', 'warning');
            }
        }

        function applyEffects(effects) {
            Object.entries(effects).forEach(([key, value]) => {
                if (gameState.stats[key] !== undefined) {
                    gameState.stats[key] = Math.max(0, Math.min(100, gameState.stats[key] + value));
                }
            });
            updateStats();
            updateFearEffect();

            // Check death conditions
            if (gameState.stats.health <= 0) {
                loadScene('death_look_back');
            }
            if (gameState.stats.sanity <= 0) {
                loadScene('death_look_back');
            }
        }

        function updateStats() {
            document.getElementById('healthBar').style.width = gameState.stats.health + '%';
            document.getElementById('healthValue').textContent = gameState.stats.health;

            document.getElementById('sanityBar').style.width = gameState.stats.sanity + '%';
            document.getElementById('sanityValue').textContent = gameState.stats.sanity;

            document.getElementById('karmaBar').style.width = gameState.stats.karma + '%';
            document.getElementById('karmaValue').textContent = gameState.stats.karma;
        }

        function updateFlags() {
            const container = document.getElementById('flagsDisplay');
            container.innerHTML = '';

            const flagLabels = {
                has_prayed_datuk_kong: { icon: 'ğŸ™', text: 'å·²æ‹œæ‹¿ç£å…¬' },
                knows_pontianak_name: { icon: 'ğŸ‘»', text: 'çŸ¥æ›‰é¬¼å' },
                yellow_vw_sighted: { icon: 'ğŸš—', text: 'ç›®æ“Šé»ƒè‰²VW' },
                grandma_appeared: { icon: 'ğŸ‘µ', text: 'é˜¿å¬¤é¡¯éˆ' },
                knows_rest_method: { icon: 'ğŸ“œ', text: 'çŸ¥æ›‰å®‰æ¯æ³•' },
                first_encounter: { icon: 'âš”ï¸', text: 'é¦–æ¬¡é­é‡' }
            };

            Object.entries(gameState.flags).forEach(([key, value]) => {
                if (flagLabels[key] && value) {
                    const flag = document.createElement('div');
                    flag.className = 'flag-item active';
                    flag.innerHTML = `<span class="flag-icon">${flagLabels[key].icon}</span>${flagLabels[key].text}`;
                    container.appendChild(flag);
                }
            });
        }

        function updateInventory() {
            const container = document.getElementById('inventoryItems');
            const badge = document.getElementById('inventoryBadge');

            container.innerHTML = '';
            badge.textContent = gameState.inventory.length;

            gameState.inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inventory-item' + (item.blessed ? ' special' : '');
                div.innerHTML = `
                    <span class="item-icon">${item.icon}</span>
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-desc">${item.desc}</div>
                        ${item.charges !== undefined ? `<div class="item-charges">å‰©é¤˜æ¬¡æ•¸: ${item.charges}/3</div>` : ''}
                        ${item.battery !== undefined ? `<div class="item-charges">é›»é‡: ${item.battery}%</div>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateFearEffect() {
            const fearLevel = 100 - gameState.stats.sanity;
            const overlay = document.getElementById('fearOverlay');

            if (fearLevel > 30) {
                overlay.classList.add('active');
                overlay.style.opacity = Math.min(1, fearLevel / 100);
            } else {
                overlay.classList.remove('active');
            }

            // Random hallucinations at high fear
            if (fearLevel > 70 && Math.random() < 0.1) {
                showHallucination();
            }
        }

        function showHallucination() {
            const texts = ['å›é ­çœ‹', 'å¥¹åœ¨ä½ èº«å¾Œ', 'å¿«è·‘', 'æ•‘æˆ‘', 'ä¸è¦ç›¸ä¿¡'];
            const text = texts[Math.floor(Math.random() * texts.length)];

            const hall = document.createElement('div');
            hall.className = 'hallucination';
            hall.textContent = text;
            hall.style.top = (20 + Math.random() * 60) + '%';
            hall.style.left = (10 + Math.random() * 80) + '%';
            hall.style.transform = `rotate(${-15 + Math.random() * 30}deg)`;

            document.getElementById('gameContainer').appendChild(hall);
            setTimeout(() => hall.remove(), 2000);
        }

        function triggerShake() {
            document.getElementById('gameContainer').classList.add('shake');
            setTimeout(() => {
                document.getElementById('gameContainer').classList.remove('shake');
            }, 500);
        }

        function triggerFlash(color = '#fff') {
            const flash = document.getElementById('flashOverlay');
            flash.style.backgroundColor = color;
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 150);
        }

        function toggleInventory() {
            document.getElementById('inventoryPanel').classList.toggle('open');
            document.getElementById('inventoryOverlay').classList.toggle('open');
        }

        function showMessage(text, type = '') {
            const toast = document.getElementById('messageToast');
            toast.textContent = text;
            toast.className = 'message-toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showEnding(scene) {
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('endingScreen').classList.add('active');

            const typeClass = scene.endingType === 'good' ? 'good' : scene.endingType === 'bad' ? 'bad' : 'neutral';
            const typeText = scene.endingType === 'good' ? 'âœ¦ å–„çµ‚ âœ¦' : scene.endingType === 'bad' ? 'âœ æƒ¡çµ‚ âœ' : 'â€” ä¸­ç«‹çµå±€ â€”';

            document.getElementById('endingType').className = 'ending-type ' + typeClass;
            document.getElementById('endingType').textContent = typeText;
            document.getElementById('endingTitle').textContent = scene.endingTitle;
            document.getElementById('endingNarration').textContent = scene.endingNarration;
            document.getElementById('endingEpilogue').textContent = scene.endingEpilogue;

            const achievementsContainer = document.getElementById('achievements');
            achievementsContainer.innerHTML = '';
            scene.achievements.forEach(a => {
                const div = document.createElement('div');
                div.className = 'achievement';
                div.textContent = 'ğŸ† ' + a;
                achievementsContainer.appendChild(div);
            });
        }

        function restartGame() {
            // Reset state
            gameState = {
                currentScene: 'start_01',
                stats: { sanity: 100, health: 100, karma: 50 },
                inventory: [
                    { id: 'phone', name: 'æ‰‹æ©Ÿ', desc: 'é›»é‡ 12%ï¼Œå®Œå…¨æ²’æœ‰è¨Šè™Ÿ', icon: 'ğŸ“±', battery: 12 },
                    { id: 'water', name: 'ä¸€ç“¶æ°´', desc: 'æ™®é€šçš„ç¤¦æ³‰æ°´', icon: 'ğŸ’§' },
                    { id: 'amulet', name: 'è­·èº«ç¬¦', desc: 'æœªé–‹å…‰', icon: 'ğŸ”®', charges: 0, blessed: false }
                ],
                flags: {
                    has_prayed_datuk_kong: false,
                    has_whistled_at_night: false,
                    knows_pontianak_name: false,
                    yellow_vw_sighted: false,
                    grandma_appeared: false,
                    knows_rest_method: false,
                    in_loop: false,
                    first_encounter: false
                },
                history: []
            };

            document.getElementById('endingScreen').classList.remove('active');
            document.getElementById('titleScreen').classList.add('active');
            document.getElementById('fearOverlay').classList.remove('active');
        }

        function saveGame() {
            const saveData = JSON.stringify(gameState);
            localStorage.setItem('karak_save', saveData);
            showMessage('éŠæˆ²å·²å„²å­˜', 'success');
        }

        function loadGame() {
            const saveData = localStorage.getItem('karak_save');
            if (saveData) {
                gameState = JSON.parse(saveData);
                document.getElementById('titleScreen').classList.remove('active');
                document.getElementById('gameScreen').classList.add('active');
                loadScene(gameState.currentScene);
                showMessage('éŠæˆ²å·²è¼‰å…¥', 'success');
            } else {
                showMessage('æ²’æœ‰æ‰¾åˆ°å­˜æª”', 'warning');
            }
        }

        function createRainDrops() {
            const container = document.getElementById('rainContainer');
            for (let i = 0; i < 100; i++) {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * 100 + '%';
                drop.style.animationDuration = (0.5 + Math.random() * 0.5) + 's';
                drop.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(drop);
            }
        }

        // Click to skip typewriter
        document.getElementById('narrativeArea').addEventListener('click', skipTypewriter);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key >= '1' && e.key <= '4') {
                const index = parseInt(e.key) - 1;
                const btns = document.querySelectorAll('.choice-btn');
                if (btns[index]) btns[index].click();
            }
            if (e.key === ' ' || e.key === 'Enter') {
                skipTypewriter();
            }
        });
    </script>
</body>
</html>
